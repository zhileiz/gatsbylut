---
title: "比特币的故事"
date: "2018-01-05"
subtitle: "Markdown is intended to be as easy-to-read and easy-to-write as is feasible."
link: "story-of-bitcoin"
category: "iOS"
lang: 'ch'
published: true
summary: "在过去的2017， 比特币和其他数字货币（cryptocurrency）火得令人瞠目结舌。上学期有机会在NETS212的课上初识了比特币/区块链作为一种分布式系统的概念，不得不叹服设计出比特币系统的“中本哲史/中本聪”可能真的是神仙下凡。"
---
在过去的2017， 比特币和其他数字货币（cryptocurrency）火得令人瞠目结舌。上学期有机会在NETS212的课上初识了比特币/区块链作为一种分布式系统的概念，不得不叹服设计出比特币系统的“中本哲史/中本聪”可能真的是神仙下凡。这种完全不依靠信任和中央控制，单纯依靠数学可靠性的交换协议，正在引领下一个互联网革命，甚至可能颠覆最根本的社会生产关系。
当然，本文暂不讨论比特币作为的投资意义或者区块链是否可以取代现有的互联网结构，也不讨论数字货币对国家主权的影响，而是单纯地整理一下比特币系统的工作原理，希望让所有被“数字签名”，“挖矿”等名词困惑的同学们有拨云见日的感觉。
### 0. 太长不看版
1. 比特币系统是一本**账本**，保存在**每个用户**手上，且不存在“中央账本”作为账本的权威。每一笔比特币交易，都会在系统中被“**广播**”，从而被记录在（所有人的）账本上。
2. **拥有**$n$块比特币意味着你可以在这本账本上有任意多的**花费记录**，而这些花费记录加起来最多不超过$n$。（如果没有其他用户再支付给你比特币的话。）
3. 每一笔支付中，支付者都会再账本这一笔的条目上留下一个独特的“**数字签名**”。数学上保证这些签名不可能被复制。
4. 账本由“**区块**”前后连接组成，可以想象成账本的页，每一页（区块）可以。除了第一个区块以外，每个区块的头部都有前一个区块的计算值（哈希值），从而在数学上保证区块不能被替换。由此，账本也叫做“**区块链**”。
5. 每十分钟，系统中会出现一个有效的**新区块**，并被广播到系统中。所有用户接收到这个新的有效区块并更新自己的账本。
6. 任何用户都可以添加新的区块，但为了保证区块有效，任何区块都有一个需要通过巨大量计算才数学上有效的“**工作量证明**”。如果这一区块的工作量证明无效，之后的新区块不会被连接在这个区块上，从而形成支路，因此只有最长的支路才是有效的区块链。因此，除非作假者有能力掌握系统中一半以上的计算能力，否则不可能维持最长的支路，达到作假的目的。
7. 由于添加新的区块需要消耗大量计算资源，区块添加者在添加有效区块时会被奖励12BTC左右的比特币，这就是所谓的“**挖矿**”。所有系统中现有的比特币都来自于“挖矿”。
8. 我们至今不知道发明比特币系统的Satoshi Nakamoto（中本哲史/中本聪）究竟是何许人也。


### 1. 从一本账本开始
想要理解比特币的工作原理，我们必须先把传统货币的大部分概念，比如银行、纸币等，仅保留“数值”这一概念。放空大脑之后，我们先来考虑一本账本：有一天，Alice、Bob、Charlie和Theeph四位同学去毕业旅行。由于经常会有小组开支或是互相之间的赊账，他们开始记账，准备在旅行后一并清算。这就是故事的开头：**一本账本，记录着需要到时清算的所有交易，且所有人都可以查看和添加新的条目**。

然而Theeph同学觉得这是一次暴富的好机会，于是他有一天晚上趁着其他人都睡着了的时候，准备向账本中添加了三条交易记录：“4. Alice需要支付Theeph一百元。”、“5. Bob需要支付Theeph两百元。”、“6. Charlie需要支付Theeph三百元”。可他看到账本时，他却发现他不可能做到，因为...
### 2. 交易中使用数字签名
他们四人设计的账本中规定：**每一条交易记录上，都必须要有支付者的签名才算有效**。显然，Theeph没有能力模仿任何一人的签名，于是他只能悻悻地睡觉去了。
在数字货币中，支付者的数字签名是交易安全性的第一块基石，它的实现原理**公钥密码技术**。简单来讲，所有用户在注册后，会得到两串密码：第一串仅自己可见，必须保管好不可让他人知道，称之为私钥；第二串公开，称之为公钥。用户**用私钥加密信息后得到的密文*只有*用与之对应的公钥才能正确解密**。因此，用户对某一消息进行加密本身就是一种签名的行为，因为其他用户可以**用这一用户的公钥对消息进行验证**。【图片plz】签名**无法被伪造**，除非伪造者知道该用户的私钥；签名**可以被复制**，因为两段消息的原文只要相同，签名后得到的密文也是相同的，但在数字货币中，由于每一笔交易都有一个不同的序号，因此没有任何两笔交易的明文内容是一样的。
数字货币（cryptocurrency）之所以得名“数字货币”正式因为保障其系统安全性、可靠性和完整性的机制中有大量的类似数字签名这样的密码学原理（cryptography）。保障数字货币权威的不是国家主权信用、黄金储备、或人与人之间的信任，而是对数学的信任。事实上，“信用”在数字货币中是不被需要的。**威胁数字货币安全性的根本前提是推翻数学本身。**
当晚，Theeph同学没有得逞。但是他想：既然这是毕业旅行了，我以后再也不会见到这些人了，那我岂不是可以随意花销，为所欲为，然后你走你的独木桥，我走我的阳关道，就此别过吧！于是他不断地赊账，欠下了三点五个亿，在毕业旅行后就此从同学们身边消失了，留下了懵逼的Alice, Bob和Charlie，直到...

### 3. 交易有效性诞生货币的概念
其实，让我们回过头来想一想，“记账后结算”这件事情本身的意义是：存在某一用户$A$，其在系统中获得的钱小于其在系统中需要支付的钱，若他继续存在在系统中，会给其他用户造成实际损失。因此如果Alice、 Bob、 Charlie和Theeph在开始旅行之前，先各自存入账本一些“可用资金”，**每人最多只能开支自己支付的可用资金之内的数额**，那么就不会存在有人欠费的问题了。
而如果我们进一步拓展地思考：如果这个旅行永远不结束，那么**只要满足以上的交易条件，可以（在参与者之内）永远不进行现实货币的结算**，而永远只使用账本。这就是比特币：**一本永不结算的记录有效交易的账本**，数额由交易记录决定。
由此，从账本衍生出了比特币货币的概念。如果我们把旅行中四人账本上的数值叫做“旅行币”，这些数额就变成了一种货币。如果这个时候有第五个人加入旅行，而Alice有1000元旅行币，他可以用人民币以1:1的价格向Alice购买一定数额的旅行币，比如200元，作为在账本上交易的先决条件（必须有钱才能花钱），而“1:1”也成为了人民币对旅行币的汇率。
可能有人会怀疑这第五个人是不是傻，这可是凭空捏造的想象出来的货币啊！但是，世界上哪一种货币不是呢？美元有价值，可以买到汽车，是因为人们都*认为*美元有价值。1块美元可以换6.8个人民币，是因为人们*认为*美元值6.8个人民币。可能有人说货币是以“真金白银”作为担保的，那么又是谁*规定*真金白银有价值的呢？因此从这个意义上，旅行币/比特币的合理性与世界上任何一种货币并无本质性差别：都是货币用户共同想象赋予的价值。

### 4. 分布式维护账本
以上这些仅仅是比特币系统神奇之处的的三分之一。比特币真正神奇的的地方是分布式维护。分布式(decentralized)的反义词是集中式(centralized)。到目前为止，主流金融管理模式都是集中式的：中国人民银行（央行）管理人民币的发行政策，蚂蚁金服管理支付宝用户的所有交易等等。虽然这些机构一般很难失信，进行账目作假的行为，否则会被追究严重的法律责任和社会责任，但也不能说他们完全没有风险失信。我们可以想像：如果一个账本系统是委托一个中央进行集中式管理的，那么只要这个中央存在失信风险，这个账本系统本身就不一定可靠。比特币认识到这一点，甚至认为**只要一个系统依靠任何参与者的“诚信”，那么这个系统就一定存在作假等风险**。因此，比特币的设计理念是“去信用化”，“去中央化”，完全不需要任何人的诚信。它将这一账目系统中所有的参与者都视为同等管理级别，从而达到“**只要系统中同时失信的参与者不超过一半，那么这个系统就是可靠的**。 
还是回到“旅行币”的例子。我们到现在为止一直没有探讨这本账本究竟存在于哪里：到底是由一个人关着，还是托管在一个第三方平台？都不是，因为如果这样管理，就会又一个可能存在作假风险的中央，所以解决方案是：**这本帐本存在于每个参与者自己手里，新的条目将会被通知到所有账本，每隔一段时间（不会太长）进行对账保持一致性（eventual consistency）。** 但这又引申出一个新的问题：对账的时候，怎么知道哪一个账本是正确的账本呢？难道我们还需要一个权威的中央吗？

### 5. 用工作量证明决定正确的账本
这里就讲到了比特币设计最精妙的思想：工作量证明。它的顶层逻辑是：每个用户手上的账本都有一个工作量证明，代表从开始到当前，该用户维护这本账本所投入的计算量（工作量）；所有账本中工作量最大的那本账本即权威账本；而造假者必须**永远保持**自己的账本工作量在系统中最大 —— 因此除非造假者掌握系统中一半以上的计算能力，否则不可能进行造假。 让我们来详细解释一下这个逻辑在比特币中的实现过程。
#### 单向散列函数
首先说明这一过程中重要的技术环节，也是密码学的基本工具之一：单向散列函数。单向散列函数是一个函数，可以简单地想象为$y = f(x)$，其中$x$是输入，可以是**任何消息或文件**，$y$是输出，是一串**二进制数**，称之为散列值。这个函数的额外性质是：1）散列值具有随机性和不可预测性，即只要输入端修改哪怕只有一个比特，输出的散列值就几乎完全不一样。2）散列函数具有单向性，即又散列值$y$直接推断原输入$x$几乎不可能做到，除非枚举输入$x$。 通常使用的单向散列函数是$SHA256()$函数，这个函数满足以上特性，且推断原输入所需要的枚举数量平均在$2^{256}$次方次——使用十亿台拥有最强性能的电脑同时计算需要枚举几十亿年。
#### 区块和区块链
那么，单向散列函数是如何在比特币中起到工作量证明的作用的呢？ 
在比特币中，账本不一个文件连续不断地记录的，而是由无数个“区块”链接而成，就好比账本中的“页”，一个区块最多可以记录2400条交易记录。区块可以由任何用户提出添加，就像账本可以由任何用户添加新的一页一样。但是系统平均每10分钟只会添加一个有效的区块，否则就好似账本无法知道真正的“下一页”是哪一页一样，这时提出添加的用户会听取系统中所有的交易请求，并记录在这一新区块上。
单向散列函数就是用于判定一个新的区块是否有效。**提出添加新区块必须在该区块所有交易记录末尾添加一个数字$\mu$，使得这一区块通过单向散列函数后得到的散列值以$k$个0开头。** 由于寻找到数字$\mu$的办法只有枚举，这一过程消耗大量的计算资源，因此数字$\mu$就是我们说的“工作量证明”，而0的数量$k$由比特币系统自动调节，使得有效新区块的计算难度平均在10分钟左右。第一个被计算出来的有效新区块将结束当前“提出新区块”的周期，并被发布到所有用户，让所有用户把这个区块附加到各自已有的账本中。
#### 区块链
当新区块不断被附加，这一由区块形成的链式结构账本也被叫做“区块链”。但是，如何证明一个新的区块是现有账本的下一页呢？这个问题还是通过单向散列函数解决：当用户提出新的区块时，必须在新的区块开头处记录上一个区块的散列值。如果一个用户篡改自己账目中某一个条目，或者更换两个区块的顺序，那么被修改的区块的散列值将与原来的散列值不同。当下一个区块所记录的散列值与上一个区块散列值不匹配时，区块链将会断链。比特币规定：**正确的区块链是最长的那一条**。因此，如果这个作弊用户想要成功作假，他必须：1）重新计算断链之后所有区块的工作量证明，2）保证自己永远是系统中成功提出有效新区块的人。不难发现，即使第一条可行，第二条根本不可能达到，除非该用户拥有系统中50%以上的计算能力。这也是区块链技术安全性的根本原理。

### 6. 挖矿和其他奖励机制
有人可能会问：既然每次提出新的区块这一工作中，工作量证明$\mu$会消耗大量的计算资源，那么为什么还会有用户去做这样的工作呢？的确，如果没有人做这样的工作，比特币系统根本不可能正常运转。大量的交易会被系统积压，无处记录；已有的记录也很有可能被篡改，因为篡改者很容易占据计算能力的大多数。 
比特币的确有解决这一问题的奖励机制，那就是如果一个用户提出一个有效的新区块，那么这个区块的第一条记录将是“该用户获得$m$个比特币”，$m$这个数将由比特币系统自动调节，指数型递减。这就是**新区块奖励（block reward）**，提出有效新区块这一工作也被形象的称之为“挖矿”，因为系统中所有的比特币都来自新区块奖励，提出新区块好比挖掘黄金。在比特币价值不断上涨的今日，越来越多的个人和机构开始从事挖矿，这对比特币系统来说是相当健康的，因为越多的人挖矿，就越不可能出现成功的作假者，但对于挖矿的个人来并不是好事，因为挖矿人越多，为了保持系统每十分钟一个新区块的节奏，计算工作量证明会越来越难。GPU是进行这样高性能计算的最佳工具，这也是为什么一段时间内高端显卡在市面上一度售罄。
另一种奖励机制是收取交易记录费。用户提出交易时，会向正在提出新区块的用户支付一小笔比特币作为自己的交易被记录的回报。如果Alice向Bob支付1元比特币，而Charlie正在挖掘新的区块，那么Alice和Bob为了使Charlie的新区块上记录下自己的交易（Charlie的区块最多只能记录2400条新交易信息），会向Charlie支付比如0.001BTC的交易费。交易记录费也使用户更有理由挖矿。

### 7. 完整的比特币协议
至此，我们已经了解了比特币系统的概念和原理，让我们来回顾一下比特币网络完整的协议，以下称“参与者”为网络中的“节点”：
1. 所有的交易信息会被通知到多个节点（主要是想提出新区块的节点）。
2. 接收到信息的节点（主要是想提出新区块的节点）将接受的交易信息在验证数字签名交易有效性之后记录在新区块上。
3. 节点不断尝试为新区块计算工作量证明。
4. 当有效的新区块被计算出来后，新区块被发送到所有节点，节点在验证区块有效性之后将新区块附加到区块链最后。
5. 系统中最长的区块（具有最大工作量）的区块是正确的区块链。
 
比特币是数字货币和区块链技术的鼻祖。作为一个网络技术，它的最大优势和特点是“去中心化”，即所有的参与者（网络节点）都是平等的，而这一切的可靠性和安全性由数学和密码学原理保障，任何尝试作假的节点，除非掌握系统中一半以上的资源和意志，都不可能成功，因为数学上不成立。同时，这一技术也有许多的改进和优化空间，当她发展到真正成熟的时候，也许会完全颠覆现有的互联网技术，引领全新的思想潮流，让我们拭目以待。另外，有趣的是，我们至今不知道发明这一系统的Satoshi Nakamoto究竟是何许人也，说不定是外星人吧？

### 8. 参考资料
1. 3Blue1Brown: Ever wonder how Bitcoin (and other cryptocurrencies) actually work?
http://www.3blue1brown.com/videos/2017/7/11/ever-wonder-how-bitcoin-and-other-cryptocurrencies-actually-work
2. 图灵程序设计丛书：《图解密码技术》，人民邮电出版社，【日】结城浩 著，周自恒 译
3. NETS 212: Case study: Bitcoin and distributed ledgers, Andreas Haeberlen, University of Pennsylvania